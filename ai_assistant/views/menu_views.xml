<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Main Menu -->
    <menuitem id="menu_ai_assistant_root"
              name="AI Assistant"
              sequence="10"
              web_icon="ai_assistant,static/description/icon.png"/>

    <!-- Chat Menu -->
    <menuitem id="menu_ai_chat"
              name="Chat"
              parent="menu_ai_assistant_root"
              action="action_ai_chat_view"
              sequence="10"/>

    <!-- My Account Menu -->
    <menuitem id="menu_ai_my_account"
              name="My Account"
              parent="menu_ai_assistant_root"
              sequence="15"/>

    <menuitem id="menu_ai_my_credits"
              name="My Credits"
              parent="menu_ai_my_account"
              action="action_ai_my_credits"
              sequence="10"/>

    <menuitem id="menu_ai_my_usage"
              name="My Usage"
              parent="menu_ai_my_account"
              action="action_ai_my_usage"
              sequence="20"/>

    <!-- Conversations Menu -->
    <menuitem id="menu_ai_conversations"
              name="Conversations"
              parent="menu_ai_assistant_root"
              action="action_ai_conversation_tree"
              sequence="20"/>

    <!-- Business Analytics (Admin) -->
    <menuitem id="menu_ai_business"
              name="Business Analytics"
              parent="menu_ai_assistant_root"
              sequence="25"
              groups="base.group_system"/>

    <menuitem id="menu_ai_business_dashboard"
              name="Dashboard"
              parent="menu_ai_business"
              action="action_ai_business_dashboard"
              sequence="10"/>

    <menuitem id="menu_ai_user_credits"
              name="User Credits"
              parent="menu_ai_business"
              action="action_ai_user_credit"
              sequence="20"/>

    <menuitem id="menu_ai_credit_transactions"
              name="Credit Transactions"
              parent="menu_ai_business"
              action="action_ai_credit_transaction"
              sequence="30"/>

    <!-- Configuration Menu -->
    <menuitem id="menu_ai_configuration"
              name="Configuration"
              parent="menu_ai_assistant_root"
              action="action_ai_assistant_config"
              sequence="30"
              groups="base.group_system"/>

    <!-- =========================== ACTIONS =========================== -->

    <!-- Chat Action -->
    <record id="action_ai_chat_view" model="ir.actions.client">
        <field name="name">AI Chat</field>
        <field name="tag">ai_chat_widget</field>
    </record>

    <!-- Conversation Actions -->
    <record id="action_ai_conversation_tree" model="ir.actions.act_window">
        <field name="name">AI Conversations</field>
        <field name="res_model">ai.conversation</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_my_conversations': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No conversations yet!
            </p>
            <p>
                Start a conversation with the AI assistant to get help with Odoo.
            </p>
        </field>
    </record>

    <!-- Configuration Action -->
    <record id="action_ai_assistant_config" model="ir.actions.act_window">
        <field name="name">AI Configuration</field>
        <field name="res_model">ai.assistant.config</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No AI configuration found!
            </p>
            <p>
                Create a configuration to connect with your AI provider (OpenAI, Anthropic).
                Only system administrators can configure API keys.
            </p>
        </field>
    </record>

    <!-- User Credit Actions -->
    <record id="action_ai_my_credits" model="ir.actions.act_window">
        <field name="name">My Credits</field>
        <field name="res_model">ai.user.credit</field>
        <field name="view_mode">form</field>
        <field name="domain">[('user_id', '=', uid)]</field>
        <field name="context">{'create': False, 'edit': False}</field>
        <field name="target">current</field>
    </record>

    <record id="action_ai_my_usage" model="ir.actions.act_window">
        <field name="name">My Usage History</field>
        <field name="res_model">ai.credit.transaction</field>
        <field name="view_mode">tree</field>
        <field name="domain">[('user_id', '=', uid)]</field>
        <field name="context">{'create': False, 'edit': False}</field>
    </record>

    <!-- Admin Credit Management -->
    <record id="action_ai_user_credit" model="ir.actions.act_window">
        <field name="name">User Credits</field>
        <field name="res_model">ai.user.credit</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No user credits found!
            </p>
            <p>Credits will be created automatically when users start using the AI assistant.</p>
        </field>
    </record>

    <record id="action_ai_credit_transaction" model="ir.actions.act_window">
        <field name="name">Credit Transactions</field>
        <field name="res_model">ai.credit.transaction</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_group_user': 1}</field>
    </record>

    <!-- Business Dashboard Action -->
    <record id="action_ai_business_dashboard" model="ir.actions.server">
        <field name="name">Business Dashboard</field>
        <field name="model_id" ref="model_ai_business_analytics"/>
        <field name="state">code</field>
        <field name="code">
# Get business metrics for the last 30 days
analytics = env['ai.business.analytics']
metrics = analytics.get_business_metrics(30)
top_users = analytics.get_top_users(30, 10)
daily_usage = analytics.get_daily_usage_chart(30)

# Prepare data for display
action = {
    'type': 'ir.actions.client',
    'tag': 'ai_business_dashboard',
    'context': {
        'metrics': metrics,
        'top_users': top_users,
        'daily_usage': daily_usage,
    }
}
        </field>
    </record>

    <!-- =========================== SHORTCUTS =========================== -->

    <!-- Quick Access Shortcuts -->
    <record id="shortcut_ai_chat" model="ir.ui.view">
        <field name="name">AI Chat Shortcut</field>
        <field name="model">ir.ui.view</field>
        <field name="type">qweb</field>
        <field name="arch" type="xml">
            <t t-name="ai_assistant.chat_shortcut">
                <div class="o_ai_chat_shortcut">
                    <a href="/web#action=ai_assistant.action_ai_chat_view" class="btn btn-primary">
                        <i class="fa fa-robot"/> Start AI Chat
                    </a>
                </div>
            </t>
        </field>
    </record>

    <!-- =========================== CRON JOBS =========================== -->

    <!-- Daily Analytics Update -->
    <record id="cron_daily_analytics" model="ir.cron">
        <field name="name">AI Assistant: Daily Analytics Update</field>
        <field name="model_id" ref="model_ai_business_analytics"/>
        <field name="state">code</field>
        <field name="code">
# Update daily business metrics
model.env['ai.business.analytics'].get_business_metrics(1)
        </field>
        <field name="interval_number">1</field>
        <field name="interval_type">days</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
    </record>

    <!-- Low Credit Warnings -->
    <record id="cron_low_credit_warnings" model="ir.cron">
        <field name="name">AI Assistant: Low Credit Warnings</field>
        <field name="model_id" ref="model_ai_user_credit"/>
        <field name="state">code</field>
        <field name="code">
# Send low credit warnings to users
low_credit_users = model.search([
    ('remaining_credits', '&lt;', 5),
    ('is_subscription_active', '=', False),
    ('low_credit_warning_sent', '=', False),
    ('is_active', '=', True)
])

for user_credit in low_credit_users:
    user_credit._send_low_credit_warning()
        </field>
        <field name="interval_number">4</field>
        <field name="interval_type">hours</field>
        <field name="numbercall">-1</field>
        <field name="active">True</field>
    </record>

    <!-- =========================== SECURITY RULES =========================== -->

    <!-- User can only see their own conversations -->
    <record id="rule_conversation_user" model="ir.rule">
        <field name="name">User can only see own conversations</field>
        <field name="model_id" ref="model_ai_conversation"/>
        <field name="domain_force">[('user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('ai_assistant.group_ai_assistant_user'))]"/>
    </record>

    <!-- User can only see their own messages -->
    <record id="rule_message_user" model="ir.rule">
        <field name="name">User can only see own messages</field>
        <field name="model_id" ref="model_ai_message"/>
        <field name="domain_force">[('conversation_id.user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('ai_assistant.group_ai_assistant_user'))]"/>
    </record>

    <!-- User can only see their own credits -->
    <record id="rule_user_credit_user" model="ir.rule">
        <field name="name">User can only see own credits</field>
        <field name="model_id" ref="model_ai_user_credit"/>
        <field name="domain_force">[('user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('ai_assistant.group_ai_assistant_user'))]"/>
    </record>

    <!-- User can only see their own transactions -->
    <record id="rule_credit_transaction_user" model="ir.rule">
        <field name="name">User can only see own transactions</field>
        <field name="model_id" ref="model_ai_credit_transaction"/>
        <field name="domain_force">[('user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('ai_assistant.group_ai_assistant_user'))]"/>
    </record>

    <!-- System admins can see everything -->
    <record id="rule_admin_all_access" model="ir.rule">
        <field name="name">Admins can see all AI data</field>
        <field name="model_id" ref="model_ai_conversation"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_system'))]"/>
    </record>

    <record id="rule_admin_all_messages" model="ir.rule">
        <field name="name">Admins can see all messages</field>
        <field name="model_id" ref="model_ai_message"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_system'))]"/>
    </record>

    <record id="rule_admin_all_credits" model="ir.rule">
        <field name="name">Admins can see all credits</field>
        <field name="model_id" ref="model_ai_user_credit"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_system'))]"/>
    </record>

    <record id="rule_admin_all_transactions" model="ir.rule">
        <field name="name">Admins can see all transactions</field>
        <field name="model_id" ref="model_ai_credit_transaction"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_system'))]"/>
    </record>
</odoo>

